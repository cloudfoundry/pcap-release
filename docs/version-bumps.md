# Dependency Updates

This repository receives two kinds of automated pull requests:
* Dependabot version updates
* CFN-CI version updates

*Dependabot* is the preferred tool for version updates since it is a well maintained tool provided
and maintained by GitHub.

*CFN-CI* is our own custom tool to update the dependencies which Dependabot does not know about.
Primarily those are the dependencies managed via BOSH.

Due to the amount of pull requests generated by these two tools it became a chore to look at them,
wait for the CI to pass, approve and merge them. Since our main safeguard are the CI checks we
decided to fully automate those updates:

1. A pull request is opened with a new version.
2. The `run-ci` label is automatically set.
3. A GitHub [workflow](/.github/workflows/automerge.yml) checks if the pull request originated from
   Dependabot, if so the PR is approved and auto-merge is enabled.
4. Once all checks pass the pull request is merged by GitHub.

Note: currently this only active for Dependabot as we are missing a separate user to approve pull
requests generated by CFN-CI.

## Known Pitfalls

* The user to approve the PR has to be a code owner as we require a code owner to review pull
  requests. [^1]
* Users can not approve their own pull requests. [^2]
* The workflow has to run using the `pull_request_target` event, otherwise it won't have access to
  the secrets. [^3]
* The secret must explicitly be set in the environment variable `GH_TOKEN` for the `gh` CLI to pick
  it up. [^4]
* For GitHub Enterprise setups the token has to be set as `GH_ENTERPRISE_TOKEN` and `GH_HOST` must
  point to the GitHub Enterprise instance. [^4][^5]

[^1]: https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners#codeowners-and-branch-protection
[^2]: https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/reviewing-changes-in-pull-requests/about-pull-request-reviews#required-reviews
[^3]: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target
[^4]: https://cli.github.com/manual/gh_help_environment
[^5]: https://github.com/cli/cli/issues/6845#issuecomment-1490157003
